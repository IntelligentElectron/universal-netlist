name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate CHANGELOG has release notes
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "::error::No release notes found in CHANGELOG.md for version $VERSION"
            echo "Add a section like '## [$VERSION] - $(date +%Y-%m-%d)' to CHANGELOG.md"
            exit 1
          fi
          echo "Found release notes for version $VERSION"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build all platforms
        run: |
          mkdir -p bin
          bun build --compile --minify --target=bun-darwin-arm64 src/index.ts --outfile bin/universal-netlist-darwin-arm64
          bun build --compile --minify --target=bun-darwin-x64 src/index.ts --outfile bin/universal-netlist-darwin-x64
          bun build --compile --minify --target=bun-linux-arm64 src/index.ts --outfile bin/universal-netlist-linux-arm64
          bun build --compile --minify --target=bun-linux-x64 src/index.ts --outfile bin/universal-netlist-linux-x64
          bun build --compile --minify --target=bun-windows-x64 src/index.ts --outfile bin/universal-netlist-windows-x64.exe

      - name: Import Apple certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the key
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Sign macOS binaries
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd bin

          # Sign both macOS binaries with JIT entitlements (required for Bun runtime)
          codesign --force --options runtime --entitlements ../entitlements.plist --sign "Developer ID Application: Valentino Zegna Baruffa ($APPLE_TEAM_ID)" universal-netlist-darwin-arm64
          codesign --force --options runtime --entitlements ../entitlements.plist --sign "Developer ID Application: Valentino Zegna Baruffa ($APPLE_TEAM_ID)" universal-netlist-darwin-x64

          # Verify signatures
          codesign --verify --verbose universal-netlist-darwin-arm64
          codesign --verify --verbose universal-netlist-darwin-x64

      - name: Notarize macOS binaries
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          cd bin

          # Create ZIP files for notarization
          zip universal-netlist-darwin-arm64.zip universal-netlist-darwin-arm64
          zip universal-netlist-darwin-x64.zip universal-netlist-darwin-x64

          # Notarize ARM64
          xcrun notarytool submit universal-netlist-darwin-arm64.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Notarize x64
          xcrun notarytool submit universal-netlist-darwin-x64.zip \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Clean up zips
          rm *.zip

      - name: Generate checksums
        run: |
          cd bin
          shasum -a 256 universal-netlist-* > checksums.txt
          cat checksums.txt

      - name: Build .mcpb desktop extension
        run: |
          chmod +x scripts/build-mcpb.sh
          RELEASE_DIR=$PWD/bin OUTPUT_DIR=$PWD/bin scripts/build-mcpb.sh ${GITHUB_REF#refs/tags/v}

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Extract section between current version header and next version header (or EOF)
          NOTES=$(awk -v ver="$VERSION" '
            /^## \[/ { if (found) exit; if ($0 ~ "\\[" ver "\\]") found=1; next }
            /^\[.*\]:/ { exit }
            found { print }
          ' CHANGELOG.md)

          # Use delimiter for multiline output
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.changelog.outputs.notes }}

            ## Installation

            See [Setup Instructions](https://github.com/IntelligentElectron/universal-netlist?tab=readme-ov-file#connect-the-mcp-with-your-favorite-ai-tool) for installation and configuration.

            ## Checksums

            See `checksums.txt` for SHA256 checksums.
          files: |
            bin/universal-netlist-darwin-arm64
            bin/universal-netlist-darwin-x64
            bin/universal-netlist-linux-arm64
            bin/universal-netlist-linux-x64
            bin/universal-netlist-windows-x64.exe
            bin/checksums.txt
            bin/universal-netlist.mcpb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    runs-on: ubuntu-latest
    needs: build-and-release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Publish to npm
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
